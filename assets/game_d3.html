<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
  <style>
    rect {
      stroke: black;
      stroke-width: 1px;
    }
    .dark {
      fill: #9E8B5D;
    }
    .light {
      fill: #D6C8A7;
    }
  </style>
</head>
<body>
  <input type="button" value="init" onclick="console.log(game.init.board())"/>
  <input type="button" value="end" onclick="console.log(game.end.board())"/>
  <script src="http://d3js.org/d3.v2.min.js?2.10.1"></script>
  <script>
    var game = {
      draw: {
        all: function(data){
          //draw the board
          if (!game.state.isBoardCreated())
            game.init.board();
        },
        pieces: function(data){
        }
      },
      init: {
        /* options = {
             svg_container: selector,
             dimension: integer,
             duration: integer (ms),
             fold: boolean
           }
        */
        board: function(options){
          var return_status = "board created";
          // parse options
          if (options == undefined){
            options = {};
            options.svg_container = "body";
            options.dimension = 720;
            options.duration = 2000;
            options.fold = true;
          } else {
            if (options.svg_container == undefined) options.svg_container = "body";
            if (options.dimension == undefined) options.dimension = 720;
            if (options.duration == undefined) options.duration = 2000; // 2 seconds
            if (options.fold != false) options.fold = true;
          }
          // save the options we used so we can use the same ones to end
          game.state.boardOptions = options;

          if (game.state.isBoardCreated()) {
            if (game.state.svg.attr("width") == options.dimension)
              return "board already exists";
            else {
              return_status = "board modified";
              game.state.svg.remove();
            }
          }

          game.state.svg = d3.select(options.svg_container).append("svg")
                             .attr("id", "game")
                             .attr("opacity", 0)
                             .attr("width", 0)
                             .attr("height", 0);
          game.state.board = game.state.svg;
          game.state.board.selectAll("rect")
                          .data([1,0,1,0,1,0,1,0,
                                 0,1,0,1,0,1,0,1,
                                 1,0,1,0,1,0,1,0,
                                 0,1,0,1,0,1,0,1,
                                 1,0,1,0,1,0,1,0,
                                 0,1,0,1,0,1,0,1,
                                 1,0,1,0,1,0,1,0,
                                 0,1,0,1,0,1,0,1])
                          .enter().append("rect")
                          .attr("x", function(d, i) {return (i % 8)*(options.dimension/8);})
                          .attr("y", function(d, i) {return parseInt(i/8)*(options.dimension/8);})
                          .attr("width", options.dimension/8)
                          .attr("height", options.dimension/8)
                          .attr("class", function(d) {return (d == 1) ? ("dark") : ("light");});

          //animations to show the board
          if (options.fold){
            game.state.svg.transition().duration(options.duration/3)
                          .style("opacity", 1)
                          .attr("width", options.dimension/2)
                          .attr("height", options.dimension/2);
            game.state.svg.transition().duration(options.duration/3).delay(options.duration/3)
                          .attr("height", options.dimension);
            game.state.svg.transition().duration(options.duration/3).delay(2*options.duration/3)
                          .attr("width", options.dimension);
          } else {
            game.state.svg.transition().duration(options.duration)
                          .style("opacity", 1)
                          .attr("width", options.dimension)
                          .attr("height", options.dimension);
          }

          return return_status;
        }
      },
      end: {
        /*
          options = {
            duration: integer
            fold: boolean
          }
        */
        // if you don't pass options, it will try to use the saved options, or revert to defaults
        board: function(options){
          if (options == undefined){
            options = {};
            if (game.state.boardOptions == undefined){
              options.duration = 2000;
              options.fold = true;
            } else {
              options = game.state.boardOptions;
            }
          } else {
            if (options.duration == undefined) options.duration = 2000; // 2 seconds
            if (options.fold != false) options.fold = true;
          }
          
          var width = game.state.svg.attr("width");

          if (options.fold) {
            game.state.svg.transition().duration(options.duration/3)
                          .attr("width", width/2);
            game.state.svg.transition().duration(options.duration/3).delay(options.duration/3)
                          .attr("height", width/2);
            game.state.svg.transition().duration(options.duration/3).delay(2*options.duration/3)
                          .style("opacity", 0)
                          .attr("width", 0)
                          .attr("height", 0)
                          .remove();
          } else {
            game.state.svg.transition().duration(options.duration)
                          .style("opacity", 0)
                          .attr("width", 0)
                          .attr("height", 0)
                          .remove();
          }
          game.state.board = {};
          game.state.svg = {};

          return "board removed";
        }
      },
      state: {
        isBoardCreated: function(){
          return d3.select("#game").node() != null;
        },
        svg: {},
        board: {}
        // boardOptions is not initialized, because 'undefined' has meaning.
      }
    };

  </script>
</body>
</html>
